# Gemini API使用量計算

## Gemini API無料プランの制限（2026年1月時点）

### 基本制限
- **リクエスト/分（RPM）**: 5-15 RPM（モデルによる）
  - `gemini-2.5-pro`: 5 RPM
  - `gemini-2.5-flash`: 15 RPM
  - `gemini-2.5-flash-lite`: 15 RPM（推奨）
- **トークン/分（TPM）**: 250,000 TPM（全モデル共通）
- **リクエスト/日（RPD）**: 20-100リクエスト/日
  - 2025年12月に大幅削減（以前は250+リクエスト/日）
- **リセット時刻**: 毎日午前0時（太平洋標準時）

### 料金
- **無料プラン**: 入力・出力トークンともに無料
- **有料プラン**: 使用量に応じて課金（詳細は[公式ページ](https://ai.google.dev/gemini-api/docs/pricing)を参照）

---

## このアプリケーションでのAPI呼び出し回数

### 1. QA機能（`/ask`）

**1回のリクエスト = 1回のGemini API呼び出し**

- ユーザーが質問を送信
- ハイブリッド検索で引用を取得
- LLMで回答を生成（**1回のAPI呼び出し**）

**計算例**:
- 1日10回の質問 → **10回のAPI呼び出し**

---

### 2. Quiz生成機能（`/quiz/generate`）

**1回のクイズ生成リクエスト = 複数回のGemini API呼び出し**

#### 呼び出し回数の内訳

1. **基本生成**: 目標数（通常5問）に達するまで、各問題ごとにLLM APIを呼び出し
   - 1問あたり平均 **1-3回**のAPI呼び出し（リトライ含む）
   - リトライが発生する理由：
     - JSONパースエラー
     - バリデーション失敗（重複、品質不足など）
     - 空応答

2. **リトライロジック**:
   - 最大試行回数: `quiz_max_attempts`（デフォルト: 10回）
   - 目標数に達するまで繰り返し試行

#### 計算例

**最良ケース（リトライなし）**:
- 5問生成 → **5回のAPI呼び出し**

**通常ケース（一部リトライあり）**:
- 5問生成、平均1.5回/問の試行 → **約7-8回のAPI呼び出し**

**最悪ケース（多数リトライ）**:
- 5問生成、平均3回/問の試行 → **約15回のAPI呼び出し**

---

## 1日の使用量見積もり

### シナリオ1: 軽度利用
- QA: 10回/日 → **10回**
- Quiz生成: 2回/日（各5問、平均1.5回/問） → **約15回**
- **合計: 約25回/日**

### シナリオ2: 中程度利用
- QA: 30回/日 → **30回**
- Quiz生成: 5回/日（各5問、平均1.5回/問） → **約38回**
- **合計: 約68回/日**

### シナリオ3: 重度利用
- QA: 50回/日 → **50回**
- Quiz生成: 10回/日（各5問、平均1.5回/問） → **約75回**
- **合計: 約125回/日**

---

## 無料プランの制限との比較

### リクエスト/日（RPD）制限

| シナリオ | 1日の使用量 | 制限（20-100 RPD） | 判定 |
|---------|-----------|------------------|------|
| 軽度利用 | 約25回 | 20-100回 | ✅ 問題なし（下限付近） |
| 中程度利用 | 約68回 | 20-100回 | ⚠️ 上限付近（注意） |
| 重度利用 | 約125回 | 20-100回 | ❌ 制限超過 |

### リクエスト/分（RPM）制限

**`gemini-2.5-pro`を使用する場合: 5 RPM**

- 1分間に5回まで
- Quiz生成（5問、平均1.5回/問 = 約8回）は約2分かかる計算
- 連続でQuiz生成を実行する場合は、**1分間隔を空ける**必要がある

**`gemini-2.5-flash-lite`を使用する場合: 15 RPM**

- 1分間に15回まで
- Quiz生成（5問、平均1.5回/問 = 約8回）は約30秒で完了可能
- より快適に使用可能

---

## 推奨事項

### 1. モデル選択
- **`gemini-flash-lite`を推奨**
  - RPM制限が緩い（15 RPM vs 5 RPM）
  - Quiz生成がより快適

### 2. 使用量の最適化
- **Quiz生成のリトライ回数を減らす**
  - プロンプトの改善
  - バリデーション条件の調整
- **キャッシュの活用**（将来実装）
  - 同じ質問に対する回答をキャッシュ

### 3. 制限超過時の対応
- **有料プランへの移行**
  - Tier 1: 有料請求アカウントをリンク
  - Tier 2: 累計支出 >$250 + 30日経過 → 150-300+ RPM
  - Tier 3: 累計支出 >$1,000 + 30日経過 → 4,000+ RPM（カスタム制限）

### 4. モニタリング
- サーバーログでAPI呼び出し回数を監視
- 1日の使用量を記録し、制限に近づいたら警告

---

## 設定ファイルでの調整

`backend/.env`で以下を設定可能：

```env
# 使用するGeminiモデル（RPM制限に影響）
GEMINI_MODEL=gemini-2.5-flash-lite  # または gemini-2.5-flash, gemini-2.5-pro

# Quiz生成の最大試行回数（リトライ回数を減らすことでAPI呼び出しを削減）
QUIZ_MAX_ATTEMPTS=5  # デフォルト: 10
```

---

## まとめ

- **QA機能**: 1回の質問 = 1回のAPI呼び出し
- **Quiz生成**: 1回の生成（5問） = 約7-15回のAPI呼び出し
- **無料プランの制限**: 20-100リクエスト/日
- **推奨**: `gemini-flash-lite`を使用し、使用量をモニタリング

制限に近づいた場合は、有料プランへの移行を検討してください。
