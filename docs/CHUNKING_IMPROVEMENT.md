# チャンキング改善レポート

## 問題の概要

「強盗が来たらどうしたらいいですか？」という質問に対して、「万引き対応」の回答が返ってくる問題が発生していました。

### 症状
1. 質問の該当箇所のチャンクが候補から欠落している
2. 見出し・段落を基準としたチャンキングがうまく働いていない
3. 「強盗」と「万引き」が同じチャンクに混在している可能性

## 原因分析

### 1. PDFの見出し検出が不十分

**問題**:
- PDFから抽出されたテキストには見出しがMarkdown形式（`##`）ではなく、番号付き形式（`2. 万引き対応`）になっている
- 現在の見出しパターン `r'^#{1,6}\s+.*$'` はMarkdown形式の見出しのみを検出するため、PDFの見出しを検出できていない

**確認結果**:
```
[防犯・災害対応マニュアル（サンプル）.pdf page=2] 行1: 2. 万引き対応
```

### 2. セクション分割が機能していない

**問題**:
- 見出しが検出されないため、セクション分割が機能せず、「強盗」と「万引き」が同じチャンクに混在している可能性がある

### 3. 検索結果の優先順位の問題

**問題**:
- キーワード検索で「強盗」を含むチャンクが十分に優先されていない
- 意味検索（semantic search）が「万引き」も関連していると判断している可能性

## 修正内容

### 1. PDFの見出しパターンを拡張

**ファイル**: `backend/app/rag/chunking.py`

**変更内容**:
- Markdown形式の見出し（`##`, `###` など）
- 番号付き見出し（`2. 万引き対応`）
- 番号付き見出し（括弧付き）（`2.1 絶対にやってはいけないこと`）
- 区切り線（`---`）

```python
heading_patterns = [
    r'^#{1,6}\s+.*$',  # Markdown形式
    r'^\d+\.\s+[^\d]',  # 番号付き見出し（例: "2. 万引き対応"）
    r'^\d+\.\d+\s+',  # 番号付き見出し（例: "2.1 絶対に"）
]
```

### 2. キーワード検索の精度向上

**ファイル**: `backend/app/search/index.py`

**変更内容**:
- 質問から重要なキーワード（核心部分）を抽出
- 重要キーワードが含まれているチャンクに高スコアを付与
- 3文字以上のキーワードはより高スコア（例: 「強盗」= 15点）

```python
# 重要なキーワードが含まれている場合は高スコア
for keyword in important_keywords:
    if keyword in text_lower:
        # 3文字以上のキーワードはより重要
        if len(keyword) >= 3:
            score += 15  # 重要キーワード（3文字以上）マッチは最高スコア
        else:
            score += 8  # 重要キーワード（2文字）マッチは高スコア
```

## 検証方法

### 1. チャンキングの確認

```bash
cd backend
source .venv/bin/activate
python scripts/debug_chunking.py
```

**期待される結果**:
- 「強盗」を含むチャンクが存在する
- 「強盗」と「万引き」が混在するチャンクが0件（または最小限）

### 2. インデックスの再構築

```bash
cd backend
source .venv/bin/activate
python scripts/build_index.py --force
```

### 3. APIテスト

```bash
curl -X POST http://localhost:8000/ask \
  -H "Content-Type: application/json" \
  -d '{"question":"強盗が来たらどうしたらいいですか？","debug":true}' \
| jq '.citations[] | {source, page, quote}'
```

**期待される結果**:
- 上位のcitationに「強盗」が含まれる
- 「万引き」のみのcitationが優先されない

## 次のステップ

1. インデックスの再構築（`build_index.py --force`）
2. チャンキングのデバッグスクリプトを実行して「強盗」と「万引き」の混在を確認
3. APIテストで検索結果を確認
4. 必要に応じて、見出しパターンやキーワード抽出ロジックをさらに調整

## 関連ファイル

- `backend/app/rag/chunking.py`: チャンキング実装（見出し検出パターン拡張）
- `backend/app/search/index.py`: キーワード検索実装（重要キーワード抽出追加）
- `backend/scripts/debug_chunking.py`: チャンキングデバッグスクリプト（新規作成）
