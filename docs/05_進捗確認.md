# 進捗確認：設計書と現状実装の差分

## 1. 実装済み（設計書通り）

### 1.1 基盤・インフラ
- ✅ Next.js (App Router) + TypeScript + Tailwind CSS
- ✅ FastAPI + Python 3.11+
- ✅ CORS設定
- ✅ エラーハンドリング（統一形式：`{error: {code, message}}`）
- ✅ レスポンシブUI（PC/モバイル対応）

### 1.2 フロントエンド画面
- ✅ QA画面（`/`）：質問入力、回答表示、引用表示（最大5件）
- ✅ クイズ画面（`/quiz`）：難易度選択、問題表示、○×ボタン、判定結果表示
- ✅ ハイブリッド検索比率スライダー（UIのみ実装）

### 1.3 APIエンドポイント（骨格）
- ✅ `GET /health`：起動確認
- ✅ `POST /ask`：質問受付（RAG検索→LLM生成実装済み）
- ✅ `POST /quiz`：クイズ生成（ダミー実装）
- ✅ `POST /judge`：クイズ判定（ダミー実装）
- ✅ `GET /docs/summary`：ドキュメントサマリー
- ✅ `POST /search`：チャンク検索（キーワード検索＋2-gramフォールバック）

### 1.4 ドキュメント処理（部分実装）
- ✅ ドキュメント読み込み（`manuals/`配下の`.txt`/`.pdf`）
- ✅ PDFテキスト抽出（PyMuPDF）
- ✅ チャンキング（LEN戦略）
- ✅ リポジトリルート基準のパス解決
- ✅ PDF読み込みエラーのログ出力

### 1.5 クイズ管理
- ✅ In-memoryストア（`quiz/store.py`）
- ✅ `NOT_FOUND`時の再出題導線

### 1.6 エラーUX
- ✅ エラーコード別の導線分岐（再試行/再出題）
- ✅ ローディング表示

---

## 2. 未実装（設計書との差分）

### 2.1 RAG検索機能（重要）
| 項目 | 設計書 | 現状 | 備考 |
|------|--------|------|------|
| Embedding生成 | 実装予定 | ✅ 実装済み | sentence-transformers使用（`intfloat/multilingual-e5-small`） |
| ベクトルDB | 実装予定 | ✅ 実装済み | ChromaDB使用（永続化、`backend/.chroma`に保存） |
| 意味検索（Semantic Search） | 実装予定 | ✅ 実装済み | コサイン類似度による意味検索 |
| インデックス自動構築 | 実装予定 | ✅ 実装済み | サーバー起動時に自動実行 |
| キーワード検索 | 実装予定 | ✅ 実装済み | スペース区切り＋部分文字列マッチング |
| 2-gram検索（日本語対応） | 記載なし | ✅ 実装済み | キーワード検索で0件の場合にフォールバック |
| ハイブリッド検索 | 実装予定 | ✅ 実装済み | semantic + keyword統合、`semantic_weight`で重み調整可能 |
| 引用抽出（最大5件） | 実装予定 | ✅ 実装済み | `/ask`で重複排除付きで最大5件 |
| `/search` エンドポイント | 記載なし | ✅ 実装済み | 検索結果を直接返すAPI |
| 観測性強化 | 記載なし | ✅ 実装済み | ログに検索結果件数・スコアを出力 |
| デバッグ機能 | 記載なし | ✅ 実装済み | `debug=true`で検索結果の詳細情報を取得可能 |
| 根拠品質改善 | 記載なし | ✅ 実装済み | ChromaDBに全文保存、APIレスポンス時に400文字で切る |

### 2.2 LLM統合（重要）
| 項目 | 設計書 | 現状 | 備考 |
|------|--------|------|------|
| LLMアダプタ層 | 実装予定 | ✅ 実装済み | `LLMClient` Protocol実装 |
| Ollama統合 | 開発初期に実装 | ✅ 実装済み | `httpx.AsyncClient` で `/api/chat` を呼び出し |
| Gemini統合 | 完成形で実装 | ❌ 未実装 | LLMアダプタ層で将来的に実装可能 |
| プロンプト生成 | 実装予定 | ✅ 実装済み | `build_messages()` で質問＋引用を構築 |
| 回答生成 | 実装予定 | ✅ 実装済み | `/ask` でLLM回答を返す（失敗時はフォールバック） |

### 2.3 API実装（ダミー状態）
| エンドポイント | 設計書の期待 | 現状 | 備考 |
|---------------|------------|------|------|
| `POST /ask` | RAG検索→LLM生成 | ✅ 実装済み | 検索→LLM生成の流れが動作 |
| `POST /search` | 記載なし | ✅ 実装済み | キーワード検索＋2-gramフォールバック |
| `POST /quiz` | RAG検索→LLM生成 | ❌ ダミー固定値 | 難易度に応じた問題生成なし |
| `POST /judge` | 正誤判定＋解説生成 | ⚠️ 部分実装 | 正誤判定のみ、解説は固定値 |

### 2.4 クイズ生成ロジック
| 項目 | 設計書 | 現状 | 備考 |
|------|--------|------|------|
| 難易度別問題生成 | プロンプトテンプレート分岐 | ❌ 未実装 | レベル表示のみ |
| 判定不能回避 | 内部再生成 | ❌ 未実装 | 検証ロジックなし |
| 根拠検証 | 引用が取得できるか確認 | ❌ 未実装 | ダミー固定値 |

### 2.5 ドキュメント取り込み先
| 項目 | 設計書 | 現状 | 備考 |
|------|--------|------|------|
| 取り込み先 | `docs/` | ✅ `manuals/` | 運用変更済み（設計書と異なる） |
| ファイル追加・編集時の反映 | 記載なし | ✅ 手順明確化 | ChromaDB再構築手順をドキュメント化 |

---

## 3. 実装状況サマリー

### 完成度
- **基盤・UI**: 約90%（画面・API骨格・エラーハンドリング）
- **RAG機能**: 約95%（読み込み・チャンキング・キーワード検索・2-gram検索・Embedding生成・ベクトルDB・意味検索・ハイブリッド検索実装済み）
- **LLM統合**: 約80%（アダプタ層・Ollama実装・プロンプト生成実装済み、Gemini未実装）
- **全体**: 約85%（基盤・RAG検索・LLM統合は整備済み、クイズ生成は未実装）

### 次の実装ステップ（設計書の順序に従う）
1. ✅ **基盤の構築**（完了）
2. ✅ **RAGの統合**（完了）
   - ✅ キーワード検索実装（スペース区切り＋部分文字列マッチング）
   - ✅ 2-gram検索実装（日本語対応フォールバック）
   - ✅ `/search` エンドポイント実装
   - ✅ `/ask` の検索統合（前処理最小化、重複排除）
   - ✅ Embedding生成（sentence-transformers使用）
   - ✅ ベクトルDB構築（ChromaDB使用、永続化対応）
   - ✅ 意味検索実装（コサイン類似度検索）
   - ✅ ハイブリッド検索統合（semantic + keyword、重み調整可能）
   - ✅ インデックス自動構築（サーバー起動時実行）
   - ✅ 観測性強化（ログ出力、CHROMA_DIRパス表示）
3. ✅ **LLMの差し替え設計**（完了）
   - ✅ `LLMClient` Protocol実装
   - ✅ Ollama実装（`httpx.AsyncClient`、`@lru_cache`でクライアント生成を抑制）
   - ✅ プロンプト生成ロジック実装
   - ⏳ Gemini実装（将来）

---

## 4. 設計書との相違点（意図的な変更）

| 項目 | 設計書 | 現状 | 理由 |
|------|--------|------|------|
| ドキュメント取り込み先 | `docs/` | `manuals/` | 設計書とマニュアルを分離する運用方針 |
| パス解決 | 記載なし | リポジトリルート基準 | より堅牢な実装 |

---

## 5. 補足

- UI/UXとAPI骨格は完成
- **RAG機能は実装済み**（キーワード検索・2-gram検索・Embedding生成・ベクトルDB・意味検索・ハイブリッド検索）
- **LLM統合は実装済み**（Ollama、LLMアダプタ層、プロンプト生成）
- `/ask` はハイブリッド検索（semantic + keyword）→LLM生成の流れが動作（LLM失敗時も `citations` を返す）
- `/search` エンドポイントで検索結果を直接確認可能
- **ChromaDBの永続化対応済み**（`backend/.chroma`に保存、起動時に自動インデックス構築）
- **観測性強化済み**（ログ出力、CHROMA_DIR/DOCS_DIR実パス表示、検索結果件数・スコア出力）
- **デバッグ機能実装済み**（`debug=true`で検索結果の詳細情報を取得可能、重みの効果を検証可能）
- **根拠品質改善済み**（ChromaDBにチャンク全文を保存、embeddingとdocumentsの整合性を保つ）
- **manuals/ファイル追加・編集時の反映手順明確化**（ChromaDB再構築手順をドキュメント化、`backend/.chroma`はgit管理対象外）
- **PDF読み込み診断機能実装済み**（PDF読み込み時のテキスト長・ページ数ログ、画像PDF検知、source分布確認）
- **パス解決統一**（repo_root計算を統一、絶対パス解決でcwd依存を排除）
- **キーワード検索ノイズ対策済み**（ストップワード除去、最小スコア閾値導入、トークンマッチ強化）
- **ハイブリッド検索精度向上**（セマンティック最小閾値導入、意味的に無関係なドキュメントを除外）
- 設計書の「段階的実装」方針に沿って、次はクイズ生成フェーズ

### manuals/ のファイル追加・編集時の反映手順

**重要**: `manuals/` にファイルを追加または編集した場合、ChromaDBの再構築が必要です。

1. **サーバーを停止**（Ctrl+C）

2. **ChromaDBを削除して再構築**:
   ```bash
   # ChromaDBディレクトリを削除（CHROMA_DIR=backend/.chroma 前提）
   rm -rf backend/.chroma
   
   # サーバーを起動（起動時に自動的にインデックスが再構築される）
   cd backend
   source .venv/bin/activate  # 仮想環境が有効な場合
   uvicorn app.main:app --reload --port 8000
   ```

3. **反映確認の最短手順**:
   ```bash
   # 1. ヘルスチェック
   curl http://localhost:8000/health
   
   # 2. 追加ファイルにしかない単語で質問して、citations[].source に追加ファイル名が出ることを確認
   curl -X POST http://localhost:8000/ask \
     -H "Content-Type: application/json" \
     -d '{"question":"追加ファイルにしかない単語"}'
   # レスポンスの citations[].source に追加したファイル名が含まれることを確認
   ```

**注意**: `backend/.chroma` ディレクトリはgit管理対象外です（`.gitignore`で除外）。ローカルのChromaDBデータは各環境で独立して管理されます。

---

## 6. 実装優先度（推奨順）

### 高優先度
1. ✅ キーワード検索実装（完了）
2. ✅ 2-gram検索実装（日本語対応、完了）
3. ✅ `/search` エンドポイント実装（完了）
4. ✅ `/ask` の検索統合（完了）
5. ✅ LLMアダプタ層実装（完了）
6. ✅ Ollama統合（完了）
7. ✅ プロンプト生成ロジック実装（完了）
8. ✅ Embedding生成（完了、sentence-transformers使用）
9. ✅ ベクトルDB構築（完了、ChromaDB使用）
10. ✅ 意味検索実装（完了、コサイン類似度検索）
11. ✅ ハイブリッド検索統合（完了、semantic + keyword）
12. ✅ インデックス自動構築（完了、サーバー起動時実行）
13. ✅ 観測性強化（完了、ログ出力、CHROMA_DIR固定）
14. ✅ デバッグ機能実装（完了、debug=trueで検索結果詳細を取得）
15. ✅ 根拠品質改善（完了、ChromaDB全文保存、APIレスポンス時に400文字で切る）
16. ✅ PDF読み込み診断機能実装（完了、テキスト長・ページ数ログ、画像PDF検知、source分布確認）
17. ✅ パス解決統一（完了、repo_root計算統一、絶対パス解決）
18. ✅ キーワード検索ノイズ対策（完了、ストップワード除去、最小スコア閾値、トークンマッチ強化）
19. ✅ ハイブリッド検索精度向上（完了、セマンティック最小閾値導入、意味的に無関係なドキュメント除外）
20. ✅ 候補品質管理（完了、動的候補数決定、総チャンク数から割合計算）
21. ✅ RRF順位融合（完了、min-max正規化廃止、絶対的品質保持）
22. ✅ Cross-Encoderリランキング（完了、上位候補再スコアリング、混線削減）
23. ✅ 相対的スコア差分フィルタリング（完了、トップとの差分で普遍的な品質管理、資料非依存）

### 中優先度
14. クイズ生成ロジック（難易度別）
15. クイズ判定の解説生成（LLM統合）

### 低優先度
16. Gemini統合（完成形）
17. 判定不能回避ロジック（品質向上）
