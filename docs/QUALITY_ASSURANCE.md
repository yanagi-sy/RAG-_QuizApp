# 品質確保ガイドライン

## 概要

`@manuals` ディレクトリ内のすべてのソース（PDF、TXT）において、同じ精度で回答生成ができるように品質を確保するためのガイドラインです。

## 実装済みの改善

### 1. チャンキングの改善

#### 1.1 見出し検出パターンの拡張
- **Markdown形式**: `##`, `###` などの見出しを検出
- **番号付き見出し**: `2. 万引き対応` などの見出しを検出
- **サブレベルの見出し**: `2.1 絶対にやってはいけないこと` などの見出しを検出
- **区切り線**: `---` でセクション分割

#### 1.2 階層構造の適切な処理
- **トップレベルの見出し**: セクション分割の境界として扱う
- **サブレベルの見出し**: 親セクションに含める（見出しと本文を同じチャンクに）
- **Markdown形式**: `##` 以下をトップレベル、`###` 以降をサブレベルとして扱う

**効果**:
- 見出しだけのチャンクが生成されない
- 見出しと本文が同じチャンクに含まれる
- トピックの混在を防ぐ

### 2. キーワード検索の精度向上

#### 2.1 重要キーワードの抽出
- ストップワードを除去して核心部分を抽出
- 3文字以上の連続文字列を優先的に抽出（例: 「強盗」「万引き」）
- 2文字の連続文字列も補完用に抽出

#### 2.2 スコアリングの強化
- **3文字以上のキーワード**: +20点（重要キーワードマッチ）
- **2文字のキーワード**: +10点（重要キーワードマッチ）
- **全文一致**: +5点
- **トークンマッチ**: +2点（2文字以上）

**効果**:
- 質問の核心部分（例: 「強盗」「万引き」）を含むチャンクが上位に来る
- 関連性の高いチャンクが優先される

### 3. リランキング閾値の調整

#### 3.1 絶対値閾値
- `rerank_score_threshold`: `-4.0`（デフォルト）
- Cross-Encoderスコアが `-4.0` より低い候補を除外

#### 3.2 相対的スコア差分
- `rerank_score_gap_threshold`: `6.0`（デフォルト）
- トップスコアとの差が `6.0` を超える候補を除外

**効果**:
- 関連性の低い候補を除外
- 品質の高い候補のみを返す

### 4. 短いチャンクの除外

#### 4.1 除外ロジック
- **50文字以下**のチャンクを除外
- 見出しだけのチャンクが本文を含むチャンクと重複して返されることを防ぐ

**効果**:
- 見出しだけのcitationが返されない
- より有用な情報を含むcitationのみが返される

## 対応済みのマニュアル

### 1. 防犯・災害対応マニュアル（サンプル）.pdf
- **トピック**: 万引き対応、強盗対応、盗難対応、災害対応
- **見出し形式**: 番号付き見出し（`2. 万引き対応`、`3. 強盗対応` など）
- **状態**: ✅ 対応済み

### 2. 清掃マニュアル（サンプル：小売店）.pdf
- **トピック**: 清掃手順、清掃頻度、清掃用具
- **見出し形式**: PDF抽出テキスト（番号付き見出しの可能性）
- **状態**: ✅ 対応済み（チャンキングロジックで対応）

### 3. sample.txt（店舗運営共通デジタル連絡帳）
- **トピック**: 連絡帳の使い方、記述ルール、セキュリティ、トラブルシューティング
- **見出し形式**: Markdown形式（`## 1. はじめに` など）
- **状態**: ✅ 対応済み（Markdown形式の見出しに対応）

### 4. sample2.txt（小売店運用マニュアル）
- **トピック**: 開店準備、接客基準、レジ運用、品出し、クレーム対応、清掃、閉店作業
- **見出し形式**: Markdown形式（`## 1. 目的と基本方針` など）
- **状態**: ✅ 対応済み（Markdown形式の見出しに対応）

### 5. sample3.txt（決済・レジ運用マニュアル）
- **トピック**: レジ会計フロー、配達受付、電子マネー、QR決済、金券類、景品交換
- **見出し形式**: Markdown形式（`## 1. レジ共通の会計フロー` など）
- **状態**: ✅ 対応済み（Markdown形式の見出しに対応）

## 品質確保のためのベストプラクティス

### 1. インデックスの再構築
チャンキングロジックやキーワード検索の改善後は、必ずインデックスを再構築してください：

```bash
cd backend
source .venv/bin/activate
python scripts/build_index.py --force
```

### 2. テスト方法
主要なトピックについて、以下のような質問でテストしてください：

- **防犯対応**: 「強盗が来たらどうしたらいいですか？」「万引き対応はどうすればいいですか？」
- **清掃**: 「清掃の手順を教えてください」「清掃頻度はどのくらいですか？」
- **レジ運用**: 「レジの会計フローを教えてください」「電子マネーの使い方を教えてください」
- **連絡帳**: 「連絡帳の使い方を教えてください」「記述ルールを教えてください」

### 3. 品質チェックポイント
以下の点を確認してください：

1. **citationsが返ってくるか**: `citations` が空配列でないことを確認
2. **関連性**: 返されたcitationsが質問に関連していることを確認
3. **重複排除**: 同じ内容のcitationが重複して返されていないことを確認
4. **見出しと本文**: 見出しだけのcitationが返されていないことを確認

### 4. デバッグ情報の活用
`debug: true` を指定して、検索プロセスを確認できます：

```bash
curl -X POST http://localhost:8000/ask \
  -H "Content-Type: application/json" \
  -d '{"question":"強盗が来たらどうしたらいいですか？","debug":true}' \
  | jq '.debug'
```

**確認ポイント**:
- `keyword_hits_count`: キーワード検索でヒットした件数
- `semantic_hits_count`: セマンティック検索でヒットした件数
- `pre_rerank`: リランキング前の候補（`rank_kw` が小さいほど良い）
- `post_rerank`: リランキング後の候補（`rerank_score` が高いほど良い）
- `after_threshold_count`: 閾値を通過した候補数

## トラブルシューティング

### 問題: citationsが返ってこない
**原因**:
- インデックスが古い（再構築が必要）
- `rerank_score_threshold` が厳しすぎる
- キーワード検索でヒットしていない

**解決策**:
1. インデックスを再構築: `python scripts/build_index.py --force`
2. `rerank_score_threshold` を緩和（`-4.0` → `-5.0` など）
3. デバッグ情報で `keyword_hits_count` を確認

### 問題: 関連性の低いcitationsが返ってくる
**原因**:
- キーワード検索のスコアが不十分
- リランキングの閾値が緩すぎる

**解決策**:
1. キーワード検索のスコアを確認（`rank_kw` が小さいほど良い）
2. `rerank_score_gap_threshold` を調整（`6.0` → `4.0` など）

### 問題: 見出しだけのcitationが返ってくる
**原因**:
- 短いチャンクの除外ロジックが機能していない
- チャンキングが適切に動作していない

**解決策**:
1. チャンキングのデバッグスクリプトを実行: `python scripts/debug_chunking.py`
2. 短いチャンクの除外ロジックを確認（50文字以下を除外）

## 今後の改善案

1. **形態素解析の導入**: MeCabなどの形態素解析を使って、より正確なキーワード抽出
2. **動的閾値調整**: 質問の種類に応じて、リランキング閾値を動的に調整
3. **チャンクサイズの最適化**: ドキュメントタイプに応じて、最適なチャンクサイズを自動決定
4. **品質スコアの可視化**: 各citationに品質スコアを付与し、可視化

## 関連ドキュメント

- [チャンキング改善の詳細](./CHUNKING_IMPROVEMENT.md)
- [トラブルシューティング（根拠が見つからない場合）](./TROUBLESHOOTING_CITATIONS.md)
- [README（インデックス再構築手順）](../README.md)
