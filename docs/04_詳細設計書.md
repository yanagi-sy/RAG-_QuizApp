# 詳細設計書

# 04_詳細設計書.md

```md
# 詳細設計書（薄め）v1.0

## 1. ディレクトリ構成（例）

※実際の構成に合わせて運用する。重要なのは責務分離（1ファイル400行以内）を守ること。

rag-quiz-app/
README.md
docs/
01_要件定義書.md
02_基本設計書.md
03_API設計書.md
04_詳細設計書.md

frontend/
app/
page.tsx # QAトップ
quiz/page.tsx # クイズ画面
features/
qa/
useAsk.ts
components/
AskForm.tsx
AnswerView.tsx
quiz/
useQuiz.ts
components/
DifficultyPicker.tsx
QuizCard.tsx
JudgeButtons.tsx
lib/
api.ts
types.ts

backend/
requirements.txt
app/
main.py
core/
settings.py
routers/
health.py
ask.py
quiz.py
judge.py
docs.py # （ある場合）docs取り込みサマリ
docs/
loader.py # txt/pdf読み込み（PDF=PyMuPDF）
chunker.py # LEN戦略で分割
models.py # Document/Chunk型
quiz/
store.py # in-memory quiz store（再起動で消える）
schemas/
ask.py
quiz.py
judge.py
common.py # error/citations など共通

markdown
コードをコピーする

## 2. RAG処理手順（箇条書き）

### 2.1 取り込み
1. `docs/` 配下の `.txt` / `.pdf` を列挙
2. txt/pdf を読み込み、共通の Document 形式に統一
   - source（ファイル名）, page（PDFページ or 1）, text（抽出本文）

### 2.2 チャンキング（LEN戦略）
3. Documentごとに文字数（LEN）を見て、段階的に chunk_size / overlap を切り替える
4. Chunkに分割し、メタ情報を付与
   - source, page, chunk_index, text

### 2.3 検索
5. 埋め込み（Embedding）を作成し、ベクトルDBへ登録（初回）
6. 問い合わせ時に類似検索（必要ならキーワード検索と併用してハイブリッド化）
7. 上位候補から引用（最大5件）を抽出して整形

### 2.4 生成
8. 「質問（または出題指示）＋引用」をプロンプトに埋め込み
9. LLMで回答/問題文/解説を生成
10. 生成結果＋引用をAPIレスポンスにして返す

## 3. クイズ生成（難易度差の付け方）

- 難易度は level（beginner/intermediate/advanced）で受ける
- 実装方針：
  - 難易度ごとにプロンプトテンプレートを分ける（表現の厳密さ・ひっかけ要素の程度など）
  - ただし曖昧になりやすい表現は避け、○/×が一意に決まる文章にする
- 判定不能はユーザーに出さない：
  - 根拠が取れない / 曖昧 / 解説が矛盾 なら内部で再生成

## 4. クイズ判定（in-memory運用）

- DB保存なしのため、/quiz 時に以下を in-memory store に保存する：
  - quiz_id, question, correct_answer, explanation, citations
- /judge は quiz_id を引いて判定する
- API再起動で store が消えるため、再起動後の /judge は NOT_FOUND を返す
  - フロントは「再出題」導線を出す

## 5. エラー設計（最小）
- すべて `{ error: { code, message } }` を基本形にする
- フロントの導線：
  - INVALID_INPUT：入力修正
  - TIMEOUT/INTERNAL/NETWORK：再試行
  - NOT_FOUND：再出題

## 6. LLM切り替え（Ollama→Gemini）
- API I/F（/ask /quiz /judge のJSON）は維持
- バック側に LLMアダプタ層を置き、実体を差し替え可能にする
  - 例：`LLMClient` インターフェース
    - `generate(prompt) -> text`
- 開発初期はOllama、完成形はGeminiを設定で切替できる形にする
