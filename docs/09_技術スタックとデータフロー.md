# 技術スタックとデータフロー解説

**初心者の方へ**  
このドキュメントでは、RAG Quiz App で使っている技術・データの流れ・各ファイルの役割を、なるべく平易に説明します。  
「なぜその技術を使うのか」「処理はどの順で進むか」を理解し、コードレビューや機能追加の足がかりにしてください。

---

## 目次
1. [用語の整理（初心者向け）](#用語の整理初心者向け)
2. [技術スタック概要](#技術スタック概要)
3. [主要技術の解説](#主要技術の解説)
4. [システムアーキテクチャ](#システムアーキテクチャ)
5. [データフロー：QA機能](#データフローqa機能)
6. [データフロー：Quiz機能](#データフローquiz機能)
7. [RAGパイプライン詳細](#ragパイプライン詳細)
8. [各ファイルの働きの概要](#各ファイルの働きの概要)

---

## 用語の整理（初心者向け）

| 用語 | 意味（このプロジェクトでの使われ方） |
|------|--------------------------------------|
| **RAG** | 検索（Retrieval）で資料から根拠を取り、LLMで回答やクイズを生成する方式。 |
| **Embedding** | 文や単語を数値のベクトル（例: 384個の数値）に変換したもの。似た意味→似たベクトル。 |
| **チャンク** | 資料を分割した1ブロック。検索・Embeddingの最小単位。 |
| **Semantic検索** | 意味の近さで検索。質問をベクトル化し、ChromaDBで似たベクトルのチャンクを取る。 |
| **キーワード検索** | 単語の一致で検索。BM25や2-gramなど。 |
| **ハイブリッド検索** | Semantic＋キーワードの両方を使い、結果を融合（RRFなど）して候補を出す。 |
| **リランキング** | 候補を (質問, 本文) のペアで再スコアし、順位を付け直す。精度向上用。 |
| **Citation** | 引用。回答・クイズの根拠となった資料の「出どころ」（source, page, quote）。 |
| **LLM** | 大規模言語モデル。Ollamaでローカル実行する llama3 等。 |

---

## 技術スタック概要

### Frontend
| 技術 | バージョン | 役割 |
|------|-----------|------|
| Next.js | 16.1.1 | Reactフレームワーク（App Router） |
| React | 19.2.3 | UIライブラリ |
| TypeScript | ^5 | 型安全な開発 |
| Tailwind CSS | ^4 | ユーティリティファーストCSS |

### Backend
| 技術 | バージョン | 役割 |
|------|-----------|------|
| FastAPI | 0.128.0 | 高速Webフレームワーク |
| Python | 3.11+ | バックエンド言語 |
| uvicorn | 0.40.0 | ASGIサーバー |
| Pydantic | 2.12.5 | データバリデーション |
| httpx | 0.27.2 | 非同期HTTPクライアント |

### RAG関連
| 技術 | バージョン | 役割 |
|------|-----------|------|
| ChromaDB | 0.5.20 | ベクトルデータベース |
| sentence-transformers | 3.3.1 | Embedding生成 |
| PyMuPDF | 1.26.7 | PDF処理 |

### LLM
| 技術 | 状態 | 役割 |
|------|------|------|
| Ollama | 実装済み | ローカルLLM実行環境 |
| Gemini API | 将来対応 | クラウドLLM（移行予定） |

**初心者向け補足**  
- **Frontend**: ユーザーが触る画面。Next.jsでページを組み、ReactでUI、TypeScriptで型安全に書く。  
- **Backend**: APIサーバー。FastAPIでルートを定義し、Pydanticでリクエスト・レスポンスを検証。  
- **RAG関連**: 資料をチャンク化→Embedding化→ChromaDBに保存し、検索で「根拠」を取る。  
- **LLM**: 根拠を元に回答・クイズを生成。Ollamaでローカル実行。

---

## 主要技術の解説

### 1. FastAPI
**役割**: RESTful API サーバー（フロントから呼ばれるAPIの窓口を提供）

**なぜ使うか**: 非同期処理が速く、型付きでバリデーションでき、`/docs` でAPI仕様が自動生成される。  
**特徴**: async/await対応、Pydanticによる型安全、依存性注入。

**本プロジェクトでの使用箇所**:
- `/ask` - QA（質問→回答）のエンドポイント
- `/quiz/generate` - クイズ生成のエンドポイント
- `/docs/summary` - ドキュメント一覧・インデックス構築
- `/search` - チャンク検索のエンドポイント

### 2. ChromaDB
**役割**: ベクトルデータベース（Embeddingを保存し、「似たベクトル」を検索する）

**なぜ使うか**: チャンクのEmbeddingを保存しておき、質問のEmbeddingと「意味が近い」チャンクを高速に取り出す。RAGの「検索」の土台。  
**特徴**: 軽量・高速、SQLiteベースで永続化、メタデータで source/page 等のフィルタが可能。

**データ構造**:
```python
{
  "id": "sample.txt:1:0",  # source:page:chunk_index
  "embedding": [0.1, 0.2, ...],  # 384次元ベクトル
  "document": "チャンクテキスト",
  "metadata": {
    "source": "sample.txt",
    "page": 1,
    "chunk_index": 0
  }
}
```

### 3. sentence-transformers
**役割**: Embedding生成（テキスト→数値ベクトルへの変換）

**なぜ使うか**: 「意味で検索」するには、文をベクトルにしないといけない。sentence-transformers でそれを実現。  
**使用モデル**: `intfloat/multilingual-e5-small`（多言語・384次元・軽量）。

**処理の流れ**:
```
テキスト → sentence-transformers → 384次元ベクトル → ChromaDBに保存 or 検索に利用
```

### 4. Ollama
**役割**: ローカルLLM実行環境（PC上でLLMを動かす）

**なぜ使うか**: 資料の根拠（Citation）を渡し、その範囲だけで回答・クイズを生成する。クラウドAPI不要でローカル完結。  
**特徴**: 複数モデル対応（llama3等）、REST API（`/api/chat`）、ストリーミング対応。

**本プロジェクトでの使用箇所**: QAの回答生成、Quizの○×問題生成。

### 5. PyMuPDF (fitz)
**役割**: PDFからテキストを抽出する

**なぜ使うか**: `manuals/` 内のPDFをページ単位で読み、チャンク分割→Embedding化→ChromaDB登録するため。  
**処理の流れ**: `PDF → PyMuPDF（ページ単位テキスト）→ チャンク分割 → Embedding化 → ChromaDB`

### 6. Pydantic
**役割**: データの形を定義し、検証する（型安全）

**なぜ使うか**: APIのリクエスト・レスポンスや設定値を「型」で明示し、不正なデータを弾く。  
**特徴**: 型ヒントベース、自動バリデーション、JSON Schema生成、環境変数は pydantic-settings で管理。

**本プロジェクトでの使用箇所**: スキーマ（Citation、QuizItem等）、設定（`app/core/settings.py`）。

---

## システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend (Next.js)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │   QA Page    │  │  Quiz Page   │  │  Search Page │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
│         │                 │                  │                  │
│         └─────────────────┴──────────────────┘                  │
│                           │                                     │
│                    HTTP (JSON)                                  │
└───────────────────────────┼─────────────────────────────────────┘
                            │
┌───────────────────────────┼─────────────────────────────────────┐
│                    Backend (FastAPI)                            │
│                           ▼                                     │
│  ┌────────────────────────────────────────────────────────┐    │
│  │              Routers (API Endpoints)                   │    │
│  │  /ask │ /quiz/generate │ /search │ /docs/summary      │    │
│  └────┬────────────┬────────────┬──────────────┬─────────┘    │
│       │            │            │              │               │
│  ┌────▼────────────▼────────────▼──────────────▼─────────┐    │
│  │                  RAG Pipeline                          │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐           │    │
│  │  │ Retrieval│  │ Rerank   │  │ Generate │           │    │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘           │    │
│  │       │             │             │                   │    │
│  │  ┌────▼─────────────▼─────────────▼─────────┐        │    │
│  │  │  Hybrid Search / Sampling                │        │    │
│  │  │  - Semantic (ChromaDB)                   │        │    │
│  │  │  - Keyword (BM25)                        │        │    │
│  │  │  - RRF Fusion                            │        │    │
│  │  └────┬────────────────────────────────────┘        │    │
│  └───────┼─────────────────────────────────────────────┘    │
│          │                                                   │
│  ┌───────▼──────────────────────────────────────────────┐   │
│  │           Data Layer                                 │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │   │
│  │  │ ChromaDB   │  │ BM25 Index │  │ Documents  │    │   │
│  │  │ (Vector)   │  │ (Keyword)  │  │ (manuals/) │    │   │
│  │  └────────────┘  └────────────┘  └────────────┘    │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              LLM Layer                               │   │
│  │  ┌────────────────┐       ┌────────────────┐       │   │
│  │  │  Ollama        │  -->  │  Gemini        │       │   │
│  │  │  (実装済み)     │       │  (将来対応)     │       │   │
│  │  └────────────────┘       └────────────────┘       │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────┘
```

---

## データフロー：QA機能

### 概要（初心者向け）
ユーザーが質問を入力 → **検索**で資料から関連チャンクを取る（Semantic＋キーワード→RRF融合→リランキング）→ 取れたチャンクを**引用（Citation）**としてLLMに渡す → LLMが**根拠だけ**を基に回答を生成 → 回答＋引用を返す。  
検索で0件になった場合や、LLMがタイムアウトした場合は、引用だけ返す・エラーメッセージを返すなどのフォールバックあり。

### 処理フロー

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. ユーザー入力                                                   │
└───────────────────────┬─────────────────────────────────────────┘
                        │ question: "二重決済とは？"
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. Hybrid Retrieval（ハイブリッド検索）                           │
│                                                                 │
│  ┌─────────────────┐         ┌─────────────────┐              │
│  │ Semantic Search │         │ Keyword Search  │              │
│  │  (ChromaDB)     │         │  (BM25)         │              │
│  └────────┬────────┘         └────────┬────────┘              │
│           │                           │                        │
│           │ Embedding                 │ Token分解              │
│           │ [0.1, 0.2, ...]          │ ["二重", "決済"]       │
│           ▼                           ▼                        │
│  ┌─────────────────┐         ┌─────────────────┐              │
│  │ Top-K (cosine)  │         │ Top-K (BM25)    │              │
│  │ similarity      │         │ score           │              │
│  └────────┬────────┘         └────────┬────────┘              │
│           │                           │                        │
│           └───────────┬───────────────┘                        │
│                       ▼                                        │
│              ┌─────────────────┐                               │
│              │  RRF Fusion     │                               │
│              │  (順位融合)      │                               │
│              └────────┬────────┘                               │
│                       │                                        │
│                       │ candidate_k 件（20〜60件）              │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. Cross-Encoder Reranking（リランキング）                       │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ モデル: cross-encoder/mmarco-mMiniLMv2-L12-H384-v1      │   │
│  │ 入力: (question, document) ペア                         │   │
│  │ 出力: relevance score                                   │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       │                                        │
│                       │ rerank_n 件（8〜12件）                  │
│                       ▼                                        │
│              ┌─────────────────┐                               │
│              │ Score Filtering │                               │
│              │ - 絶対値閾値     │                               │
│              │ - Gap閾値       │                               │
│              └────────┬────────┘                               │
│                       │                                        │
│                       │ top_k 件（最終5件）                     │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. Citation 作成                                                │
│                                                                 │
│  各チャンクから Citation オブジェクトを作成:                     │
│  {                                                              │
│    "source": "sample.txt",                                      │
│    "page": null,                                                │
│    "quote": "チャンクテキスト（最大240文字）"                     │
│  }                                                              │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 5. LLM 回答生成                                                 │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Prompt 構築:                                            │   │
│  │  - System: 根拠に基づく回答を指示                        │   │
│  │  - User: 質問 + Citations（根拠）                       │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       │                                        │
│                       ▼                                        │
│              ┌─────────────────┐                               │
│              │  Ollama LLM     │                               │
│              │  (llama3 等)    │                               │
│              └────────┬────────┘                               │
│                       │                                        │
│                       │ answer: "二重決済とは..."               │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 6. レスポンス返却                                               │
│                                                                 │
│  {                                                              │
│    "answer": "二重決済とは、同じ取引が2回処理されること...",    │
│    "citations": [                                               │
│      {"source": "sample.txt", "page": null, "quote": "..."},   │
│      ...                                                        │
│    ]                                                            │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
```

### 主要パラメータ

| パラメータ | デフォルト値 | 説明 |
|-----------|------------|------|
| candidate_k | 動的（20〜60） | ハイブリッド検索の候補数 |
| rerank_n | 動的（8〜12） | リランク対象数 |
| top_k | 5 | 最終的な引用数 |
| semantic_weight | 0.5 | Semantic検索の重み（0.0〜1.0） |
| rerank_score_threshold | -1.5 | 絶対値閾値 |
| rerank_score_gap_threshold | 6.0 | トップスコアとの差分閾値 |

---

## データフロー：Quiz機能

### 概要（初心者向け）
**検索は使わない**。指定した1つの資料（source）から、チャンクIDを**ランダムにサンプル**し、難易度（beginner/intermediate/advanced）に合うものを選んで引用とする。  
その引用をLLMに渡し、○×問題（肯定文のみ）をJSONで生成。パース・バリデーションで弾かれたものは再試行し、規定数に達するまで繰り返す。  
`source_ids` は1件必須。規定数に達しない場合は422エラーで、不足数・却下理由などの debug 情報を返す。

### 処理フロー

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. ユーザー入力                                                   │
└───────────────────────┬─────────────────────────────────────────┘
                        │ level: "beginner", count: 5
                        │ source_ids: ["sample.txt"]
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. Chunk Pool 構築（初回のみ、以降はキャッシュ）                   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ChromaDB → source ごとに chunk ID を集計               │   │
│  │                                                         │   │
│  │ pool = {                                                │   │
│  │   "sample.txt": ["id1", "id2", ...],                   │   │
│  │   "sample2.txt": ["id10", "id11", ...],                │   │
│  │   ...                                                   │   │
│  │ }                                                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  特徴:                                                          │
│  - Unicode NFC 正規化（macOS NFD対策）                         │
│  - バッチ取得（offset/limit）                                  │
│  - Thread-safe（threading.Lock）                              │
│  - 1source あたり最大 3000 ID                                  │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. Chunk サンプリング                                           │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ sample_n = max(count * 4, 20)                          │   │
│  │                                                         │   │
│  │ source_ids 指定あり:                                    │   │
│  │   → その source から均等にサンプル                       │   │
│  │                                                         │   │
│  │ source_ids 指定なし:                                    │   │
│  │   → 全 source から均等にサンプル                         │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       │                                        │
│                       │ sampled_ids: ["id1", "id5", ...]       │
│                       ▼                                        │
│              ┌─────────────────┐                               │
│              │ collection.get  │                               │
│              │ (ids, docs,     │                               │
│              │  metadatas)     │                               │
│              └────────┬────────┘                               │
│                       │                                        │
│                       │ chunks: [{id, document, metadata}]     │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. Chunk 選択（難易度別フィルタ）                                │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ スコアリング（ヒューリスティック）:                       │   │
│  │                                                         │   │
│  │ beginner:                                               │   │
│  │   - キーワード: 概要/定義/目的/基本/ルール              │   │
│  │                                                         │   │
│  │ intermediate:                                           │   │
│  │   - キーワード: 手順/方法/対応/フロー/操作              │   │
│  │                                                         │   │
│  │ advanced:                                               │   │
│  │   - キーワード: 例外/禁止/注意/判断/リスク              │   │
│  │                                                         │   │
│  │ ボーナス:                                                │   │
│  │   - 見出し（##, ###）                                   │   │
│  │   - 最適な長さ（200〜800文字）                          │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       │                                        │
│                       │ selected_chunks: top_n 件               │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 5. Citation 作成                                                │
│                                                                 │
│  最低 3 件の Citations を確保:                                   │
│  - 不足なら sample_n を増やして再取得（最大2回）                 │
│  - 重複排除（source, page, quote先頭60文字）                    │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 6. LLM クイズ生成（3層ガード）                                   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Layer 1: Prompt 強化                                    │   │
│  │  - "JSONのみ出力"を強制                                 │   │
│  │  - 出力例を提示                                         │   │
│  │  - よくある間違いを明示                                  │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       ▼                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Ollama LLM                                              │   │
│  │  - count 個の○×クイズを JSON で生成                     │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       ▼                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Layer 2: Robust JSON Parse                             │   │
│  │  - コードフェンス除去                                    │   │
│  │  - 先頭/末尾の余計な文字除去                             │   │
│  │  - {} 抽出                                              │   │
│  │  - json.loads()                                         │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       │                                        │
│                       ▼                                        │
│              ┌─────────────────┐                               │
│              │ Parse Success?  │                               │
│              └────────┬────────┘                               │
│                       │ No                                     │
│                       ▼                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Layer 3: JSON修復リトライ（1回のみ）                     │   │
│  │  - 修復専用プロンプト                                    │   │
│  │  - 同一 citations                                        │   │
│  │  - 前回のエラー内容を含める                              │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       │                                        │
│                       ▼                                        │
│              ┌─────────────────┐                               │
│              │  Ollama LLM     │                               │
│              │  (修復試行)      │                               │
│              └────────┬────────┘                               │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 7. バリデーション                                               │
│                                                                 │
│  各クイズアイテムをチェック:                                     │
│  - statement に疑問符（?/?）がないか                            │
│  - type が "true_false" か                                      │
│  - answer_bool が bool 型か                                     │
│  - citations が1件以上あるか                                    │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 8. レスポンス返却                                               │
│                                                                 │
│  {                                                              │
│    "quizzes": [                                                 │
│      {                                                          │
│        "id": "abc123",                                          │
│        "type": "true_false",                                    │
│        "statement": "地震時は最初に身を守る行動をとる。",       │
│        "answer_bool": true,                                     │
│        "explanation": "マニュアルに明記されている。",           │
│        "citations": [...]                                       │
│      },                                                         │
│      ...                                                        │
│    ]                                                            │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
```

### 主要パラメータ

| パラメータ | デフォルト値 | 説明 |
|-----------|------------|------|
| quiz_pool_max_ids_per_source | 3000 | 1sourceあたりの最大保持ID数 |
| quiz_sample_multiplier | 4 | サンプル数の倍率 |
| quiz_sample_min_n | 20 | サンプル数の最小値 |
| quiz_citations_min | 3 | 最低引用数 |
| quiz_quote_max_len | 200 | 引用の最大文字数 |

---

## RAGパイプライン詳細

### 1. ドキュメント読み込み（Indexing）

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. ファイル読み込み                                              │
│                                                                 │
│  manuals/ ディレクトリから:                                      │
│  - *.txt → テキストファイル読み込み                              │
│  - *.pdf → PyMuPDF でページ単位テキスト抽出                      │
└───────────────────────┬─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. チャンク分割（LEN戦略）                                       │
│                                                                 │
│  パラメータ:                                                    │
│  - chunk_size: 800文字                                          │
│  - chunk_overlap: 120文字                                       │
│                                                                 │
│  処理:                                                          │
│  - 改行で段落分割                                                │
│  - chunk_size に収まるように結合                                 │
│  - 長すぎる段落は chunk_size で分割                              │
│  - chunk_overlap で重複を持たせる                                │
└───────────────────────┬─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. Embedding 生成                                               │
│                                                                 │
│  モデル: intfloat/multilingual-e5-small                         │
│  - 各チャンクテキスト → 384次元ベクトル                          │
│  - CPU/GPU 自動選択                                             │
│  - バッチ処理（高速化）                                          │
└───────────────────────┬─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. ChromaDB 保存（upsert）                                      │
│                                                                 │
│  各チャンクを保存:                                               │
│  - id: "source:page:chunk_index"                                │
│  - embedding: [0.1, 0.2, ...]                                   │
│  - document: チャンクテキスト                                    │
│  - metadata: {source, page, chunk_index}                        │
│                                                                 │
│  upsert で重複を自動更新                                         │
└─────────────────────────────────────────────────────────────────┘
```

### 2. ハイブリッド検索（QA機能）

```
┌─────────────────────────────────────────────────────────────────┐
│ Semantic Search (ChromaDB)                                      │
│                                                                 │
│  query → Embedding → コサイン類似度検索 → Top-K                  │
│                                                                 │
│  特徴:                                                          │
│  - 意味的な類似度を捉える                                        │
│  - 同義語・言い換えに強い                                        │
│  - 候補数: candidate_k                                          │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ Keyword Search (BM25)                                           │
│                                                                 │
│  query → トークン化 → BM25スコア計算 → Top-K                     │
│                                                                 │
│  特徴:                                                          │
│  - 正確な単語マッチに強い                                        │
│  - 専門用語・固有名詞に強い                                      │
│  - TF-IDF ベースのスコアリング                                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ RRF (Reciprocal Rank Fusion)                                   │
│                                                                 │
│  Semantic と Keyword の結果を融合:                               │
│                                                                 │
│  RRF_score = Σ (1 / (k + rank))                                │
│  k = 20 (パラメータ)                                            │
│                                                                 │
│  特徴:                                                          │
│  - 順位ベースの融合（スコア正規化不要）                          │
│  - semantic_weight で調整可能                                   │
│  - 両方の強みを活かす                                            │
└─────────────────────────────────────────────────────────────────┘
```

### 3. Cross-Encoder リランキング

```
┌─────────────────────────────────────────────────────────────────┐
│ モデル: cross-encoder/mmarco-mMiniLMv2-L12-H384-v1              │
│                                                                 │
│  処理:                                                          │
│  1. (query, document) ペアごとにスコアリング                     │
│  2. スコアで降順ソート                                           │
│  3. 絶対値閾値でフィルタ（-1.5以下を除外）                       │
│  4. Gap閾値でフィルタ（トップとの差6.0以上を除外）               │
│  5. Top-K を選択                                                │
│                                                                 │
│  特徴:                                                          │
│  - Bi-Encoder（Semantic）より高精度                             │
│  - 計算コストが高いため候補を絞ってから適用                       │
│  - 多言語対応（日本語含む）                                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 各ファイルの働きの概要

コードベース全体を理解するために、**各ファイルの役割**を一覧にまとめました。  
「どこで何をしているか」を追うときの目安にしてください。

### Backend（`backend/app/`）

| ファイル | 働きの概要 |
|----------|-------------|
| **main.py** | FastAPI のエントリーポイント。CORS・ルーター登録・起動時のインデックス作成。 |
| **core/settings.py** | 環境変数・設定の一元管理（CORS, RAG, 検索, Quiz, Ollama など）。 |
| **core/errors.py** | API エラー形式の統一。`AppError` と `raise_invalid_input` 等のヘルパー。 |
| **docs/loader.py** | `manuals/` 内の txt/pdf を読み、`Document` のリストに変換。 |
| **docs/chunker.py** | ドキュメントをチャンク分割。見出し境界優先・カテゴリ別 size/overlap。 |
| **docs/models.py** | `Document` / `DocumentChunk` の型定義（dataclass）。 |
| **rag/embedding.py** | テキスト→Embedding 変換。E5 の query/passage prefix 対応。 |
| **rag/vectorstore.py** | ChromaDB の取得・upsert・検索・件数取得。 |
| **rag/indexer.py** | ドキュメント→チャンク→Embedding→ChromaDB 登録（インデックス構築）。 |
| **rag/chunking.py** | RAG 用チャンキング（見出し・区切り優先）。 |
| **llm/base.py** | LLM の抽象インターフェース（Protocol）と `LLMTimeoutError` / `LLMInternalError`。 |
| **llm/ollama.py** | Ollama クライアント。`/api/chat` でメッセージ送信・回答取得。 |
| **llm/prompt.py** | QA 用・Quiz 用・JSON 修復用プロンプトの組み立て。 |
| **search/index.py** | キーワード検索＋2-gram フォールバック。チャンクのインデックス・検索。 |
| **search/reranker.py** | Cross-Encoder で (query, doc) を再スコアし、候補をリランク。 |
| **search/snippet.py** | 検索結果用スニペット・引用（quote）の生成。 |
| **quiz/chunk_pool.py** | 資料ごとのチャンク ID プール。サンプリング用に保持。 |
| **quiz/chunk_selector.py** | 難易度別キーワードでチャンクをスコアし、出題向きを選ぶ。 |
| **quiz/retrieval.py** | Quiz 用 retrieval。サンプリングで根拠を取得し、Citation を作成。 |
| **quiz/generator.py** | LLM でクイズ生成→パース→バリデーション。1 回分の生成。 |
| **quiz/generation_handler.py** | 目標数に達するまで複数回生成。citation 重複対策・banned_statements。 |
| **quiz/duplicate_checker.py** | 重複チェック機能。statement の正規化・コア内容キー比較・citation 重複チェック。 |
| **quiz/fixed_question_converter.py** | 固定問題変換。4問目・5問目を×問題に変換（複数の代替方法を試行）。 |
| **quiz/parser.py** | LLM 出力の JSON を堅牢にパース（コードフェンス除去等）。 |
| **quiz/validator.py** | クイズのバリデーション。採用/却下の判定。 |
| **quiz/store.py** | クイズ・クイズセットの保存・一覧・取得・削除（JSON ファイル）。 |
| **quiz/debug_builder.py** | エラー・デバッグ用レスポンスの構築。 |
| **routers/ask.py** | `POST /ask`。ハイブリッド検索＋LLM で回答・引用を返す。 |
| **routers/quiz.py** | `POST /quiz`, `POST /quiz/generate`, QuizSet の CRUD。 |
| **routers/search.py** | `POST /search`。キーワード検索で候補＋スニペットを返す。 |
| **routers/docs.py** | `GET /docs/summary`, `GET /docs/sources`。 |
| **routers/health.py** | `GET /health`。死活確認。 |
| **routers/judge.py** | `POST /judge`。採点。quiz_id・回答から正誤・解説・引用を返す。 |
| **routers/sources.py** | `GET /sources`。Chroma の source 一覧。 |
| **schemas/common.py** | `Citation`, `SourceInfo` 等の共通型。 |
| **schemas/ask.py** | Ask のリクエスト・レスポンス型。 |
| **schemas/quiz.py** | Quiz 生成・QuizSet・QuizItem の型。 |
| **schemas/judge.py** | Judge のリクエスト・レスポンス型。 |
| **schemas/search.py** | Search のリクエスト・レスポンス型。 |

### Frontend（`frontend/`）

| ファイル | 働きの概要 |
|----------|-------------|
| **app/page.tsx** | ホーム（`/`）。QA ページを表示。 |
| **app/layout.tsx** | 全ページ共通レイアウト。フォント・ヘッダーナビ（QA / クイズ）。 |
| **app/quiz/page.tsx** | クイズページ。生成タブ（資料・難易度・件数→生成→プレイ）と管理タブ。 |
| **app/quiz/play/[id]/page.tsx** | クイズプレイ（`/quiz/play/:id`）。1 問ずつ○×で回答・正誤・解説表示。 |
| **features/qa/QAPage.tsx** | QA メイン UI。RetrievalSlider・AskForm・AnswerView を組み合わせる。 |
| **features/qa/useAsk.ts** | QA 用フック。質問送信・回答表示・semantic_weight・retry。 |
| **features/qa/components/AskForm.tsx** | 質問入力フォーム。空欄チェック・INVALID_INPUT 表示。 |
| **features/qa/components/AnswerView.tsx** | 回答・引用表示。loading / エラー / 再試行ボタン。 |
| **features/qa/components/RetrievalSlider.tsx** | 意味検索 vs キーワード検索のバランス用スライダー。 |
| **features/quiz/useQuiz.ts** | クイズ用フック。出題・採点・retry・reset（旧 /quiz 向け）。 |
| **features/quiz/components/DifficultyPicker.tsx** | 難易度選択 UI。ラジオ＋出題ボタン。 |
| **features/quiz/components/JudgeButtons.tsx** | ○×判定ボタン。 |
| **features/quiz/components/QuizCard.tsx** | 1 問表示用カード。 |
| **lib/api.ts** | API 呼び出し共通。fetchApi・Ask / Quiz / Judge / Search / Docs / Sources。 |
| **lib/types.ts** | API の型定義。ApiError, Citation, Ask/Quiz/Judge 等。 |

---

## まとめ（初心者向け）

このシステムでは、**RAG**（検索で根拠を取り、LLM で答えを出す仕組み）を使って、次の2つを実現しています。

1. **QA機能**  
   質問 → ハイブリッド検索（意味＋キーワード）→ リランキング → 引用を LLM に渡す → 回答を生成。  
   検索や LLM が失敗したときのフォールバックあり。

2. **Quiz機能**  
   指定した1資料からチャンクを**サンプリング**（検索なし）→ 難易度フィルタ → 引用を LLM に渡す → ○×問題を JSON で生成。  
   パース・バリデーションで弾いた分は再試行し、規定数に達するまで繰り返す。

**技術スタック**は、Frontend（Next.js / React / TypeScript）、Backend（FastAPI / Pydantic）、RAG（ChromaDB / Embedding / 検索・リランク）、LLM（Ollama）に分かれており、**各ファイルの役割**は「各ファイルの働きの概要」で一覧できるようになっています。  
コードレビューや機能追加のときは、このドキュメントとソース内のコメントをあわせて参照すると、全体の流れを追いやすくなります。
