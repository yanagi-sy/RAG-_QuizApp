# 技術スタックとデータフロー解説

## 目次
1. [技術スタック概要](#技術スタック概要)
2. [主要技術の解説](#主要技術の解説)
3. [システムアーキテクチャ](#システムアーキテクチャ)
4. [データフロー：QA機能](#データフローqa機能)
5. [データフロー：Quiz機能](#データフローquiz機能)
6. [RAGパイプライン詳細](#ragパイプライン詳細)

---

## 技術スタック概要

### Frontend
| 技術 | バージョン | 役割 |
|------|-----------|------|
| Next.js | 16.1.1 | Reactフレームワーク（App Router） |
| React | 19.2.3 | UIライブラリ |
| TypeScript | ^5 | 型安全な開発 |
| Tailwind CSS | ^4 | ユーティリティファーストCSS |

### Backend
| 技術 | バージョン | 役割 |
|------|-----------|------|
| FastAPI | 0.128.0 | 高速Webフレームワーク |
| Python | 3.11+ | バックエンド言語 |
| uvicorn | 0.40.0 | ASGIサーバー |
| Pydantic | 2.12.5 | データバリデーション |
| httpx | 0.27.2 | 非同期HTTPクライアント |

### RAG関連
| 技術 | バージョン | 役割 |
|------|-----------|------|
| ChromaDB | 0.5.20 | ベクトルデータベース |
| sentence-transformers | 3.3.1 | Embedding生成 |
| PyMuPDF | 1.26.7 | PDF処理 |

### LLM
| 技術 | 状態 | 役割 |
|------|------|------|
| Ollama | 実装済み | ローカルLLM実行環境 |
| Gemini API | 将来対応 | クラウドLLM（移行予定） |

---

## 主要技術の解説

### 1. FastAPI
**役割**: RESTful API サーバー

**特徴**:
- 高速な非同期処理（async/await対応）
- 自動OpenAPIドキュメント生成（`/docs`）
- Pydanticによる型安全なバリデーション
- 依存性注入（Dependency Injection）

**本プロジェクトでの使用箇所**:
- `/ask` - QA機能のエンドポイント
- `/quiz/generate` - Quiz生成エンドポイント
- `/docs/summary` - ドキュメント一覧・インデックス構築
- `/search` - 検索エンドポイント

### 2. ChromaDB
**役割**: ベクトルデータベース（Embedding保存・類似度検索）

**特徴**:
- 軽量・高速なベクトル検索
- 永続化サポート（SQLite3ベース）
- メタデータフィルタリング
- コサイン類似度検索

**本プロジェクトでの使用箇所**:
- ドキュメントチャンクのEmbeddingを保存
- Semantic検索（意味的類似度検索）
- メタデータフィルタ（source、pageなど）

**データ構造**:
```python
{
  "id": "sample.txt:1:0",  # source:page:chunk_index
  "embedding": [0.1, 0.2, ...],  # 384次元ベクトル
  "document": "チャンクテキスト",
  "metadata": {
    "source": "sample.txt",
    "page": 1,
    "chunk_index": 0
  }
}
```

### 3. sentence-transformers
**役割**: Embedding生成（テキスト→ベクトル変換）

**使用モデル**: `intfloat/multilingual-e5-small`
- 多言語対応（日本語含む）
- 384次元のEmbeddingベクトル
- 軽量・高速

**処理フロー**:
```
テキスト → sentence-transformers → 384次元ベクトル → ChromaDB
```

### 4. Ollama
**役割**: ローカルLLM実行環境

**特徴**:
- ローカルで完結（プライバシー保護）
- 複数モデル対応（llama3など）
- REST API提供
- ストリーミング応答対応

**本プロジェクトでの使用箇所**:
- QA機能の回答生成
- Quiz問題の自動生成

### 5. PyMuPDF (fitz)
**役割**: PDF処理

**特徴**:
- 高速なPDFパース
- ページ単位のテキスト抽出
- メタデータ取得

**処理フロー**:
```
PDF → PyMuPDF → ページ単位テキスト → チャンク分割 → Embedding化
```

### 6. Pydantic
**役割**: データバリデーション・型安全

**特徴**:
- Pythonの型ヒントベース
- 自動バリデーション
- JSON Schema生成
- 環境変数管理（pydantic-settings）

**本プロジェクトでの使用箇所**:
- リクエスト/レスポンススキーマ定義
- 設定管理（`app/core/settings.py`）
- モデル定義（Citation、QuizItemなど）

---

## システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend (Next.js)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │   QA Page    │  │  Quiz Page   │  │  Search Page │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
│         │                 │                  │                  │
│         └─────────────────┴──────────────────┘                  │
│                           │                                     │
│                    HTTP (JSON)                                  │
└───────────────────────────┼─────────────────────────────────────┘
                            │
┌───────────────────────────┼─────────────────────────────────────┐
│                    Backend (FastAPI)                            │
│                           ▼                                     │
│  ┌────────────────────────────────────────────────────────┐    │
│  │              Routers (API Endpoints)                   │    │
│  │  /ask │ /quiz/generate │ /search │ /docs/summary      │    │
│  └────┬────────────┬────────────┬──────────────┬─────────┘    │
│       │            │            │              │               │
│  ┌────▼────────────▼────────────▼──────────────▼─────────┐    │
│  │                  RAG Pipeline                          │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐           │    │
│  │  │ Retrieval│  │ Rerank   │  │ Generate │           │    │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘           │    │
│  │       │             │             │                   │    │
│  │  ┌────▼─────────────▼─────────────▼─────────┐        │    │
│  │  │  Hybrid Search / Sampling                │        │    │
│  │  │  - Semantic (ChromaDB)                   │        │    │
│  │  │  - Keyword (BM25)                        │        │    │
│  │  │  - RRF Fusion                            │        │    │
│  │  └────┬────────────────────────────────────┘        │    │
│  └───────┼─────────────────────────────────────────────┘    │
│          │                                                   │
│  ┌───────▼──────────────────────────────────────────────┐   │
│  │           Data Layer                                 │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │   │
│  │  │ ChromaDB   │  │ BM25 Index │  │ Documents  │    │   │
│  │  │ (Vector)   │  │ (Keyword)  │  │ (manuals/) │    │   │
│  │  └────────────┘  └────────────┘  └────────────┘    │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              LLM Layer                               │   │
│  │  ┌────────────────┐       ┌────────────────┐       │   │
│  │  │  Ollama        │  -->  │  Gemini        │       │   │
│  │  │  (実装済み)     │       │  (将来対応)     │       │   │
│  │  └────────────────┘       └────────────────┘       │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────┘
```

---

## データフロー：QA機能

### 概要
ユーザーの質問に対して、ドキュメントから関連情報を検索し、LLMで回答を生成する。

### 処理フロー

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. ユーザー入力                                                   │
└───────────────────────┬─────────────────────────────────────────┘
                        │ question: "二重決済とは？"
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. Hybrid Retrieval（ハイブリッド検索）                           │
│                                                                 │
│  ┌─────────────────┐         ┌─────────────────┐              │
│  │ Semantic Search │         │ Keyword Search  │              │
│  │  (ChromaDB)     │         │  (BM25)         │              │
│  └────────┬────────┘         └────────┬────────┘              │
│           │                           │                        │
│           │ Embedding                 │ Token分解              │
│           │ [0.1, 0.2, ...]          │ ["二重", "決済"]       │
│           ▼                           ▼                        │
│  ┌─────────────────┐         ┌─────────────────┐              │
│  │ Top-K (cosine)  │         │ Top-K (BM25)    │              │
│  │ similarity      │         │ score           │              │
│  └────────┬────────┘         └────────┬────────┘              │
│           │                           │                        │
│           └───────────┬───────────────┘                        │
│                       ▼                                        │
│              ┌─────────────────┐                               │
│              │  RRF Fusion     │                               │
│              │  (順位融合)      │                               │
│              └────────┬────────┘                               │
│                       │                                        │
│                       │ candidate_k 件（20〜60件）              │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. Cross-Encoder Reranking（リランキング）                       │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ モデル: cross-encoder/mmarco-mMiniLMv2-L12-H384-v1      │   │
│  │ 入力: (question, document) ペア                         │   │
│  │ 出力: relevance score                                   │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       │                                        │
│                       │ rerank_n 件（8〜12件）                  │
│                       ▼                                        │
│              ┌─────────────────┐                               │
│              │ Score Filtering │                               │
│              │ - 絶対値閾値     │                               │
│              │ - Gap閾値       │                               │
│              └────────┬────────┘                               │
│                       │                                        │
│                       │ top_k 件（最終5件）                     │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. Citation 作成                                                │
│                                                                 │
│  各チャンクから Citation オブジェクトを作成:                     │
│  {                                                              │
│    "source": "sample.txt",                                      │
│    "page": null,                                                │
│    "quote": "チャンクテキスト（最大240文字）"                     │
│  }                                                              │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 5. LLM 回答生成                                                 │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Prompt 構築:                                            │   │
│  │  - System: 根拠に基づく回答を指示                        │   │
│  │  - User: 質問 + Citations（根拠）                       │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       │                                        │
│                       ▼                                        │
│              ┌─────────────────┐                               │
│              │  Ollama LLM     │                               │
│              │  (llama3 等)    │                               │
│              └────────┬────────┘                               │
│                       │                                        │
│                       │ answer: "二重決済とは..."               │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 6. レスポンス返却                                               │
│                                                                 │
│  {                                                              │
│    "answer": "二重決済とは、同じ取引が2回処理されること...",    │
│    "citations": [                                               │
│      {"source": "sample.txt", "page": null, "quote": "..."},   │
│      ...                                                        │
│    ]                                                            │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
```

### 主要パラメータ

| パラメータ | デフォルト値 | 説明 |
|-----------|------------|------|
| candidate_k | 動的（20〜60） | ハイブリッド検索の候補数 |
| rerank_n | 動的（8〜12） | リランク対象数 |
| top_k | 5 | 最終的な引用数 |
| semantic_weight | 0.5 | Semantic検索の重み（0.0〜1.0） |
| rerank_score_threshold | -1.5 | 絶対値閾値 |
| rerank_score_gap_threshold | 6.0 | トップスコアとの差分閾値 |

---

## データフロー：Quiz機能

### 概要
ドキュメントから○×クイズを自動生成する。「教材サンプリング方式」を採用し、検索ではなくランダムサンプリングで出題点を選ぶ。

### 処理フロー

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. ユーザー入力                                                   │
└───────────────────────┬─────────────────────────────────────────┘
                        │ level: "beginner", count: 5
                        │ source_ids: ["sample.txt"]
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. Chunk Pool 構築（初回のみ、以降はキャッシュ）                   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ChromaDB → source ごとに chunk ID を集計               │   │
│  │                                                         │   │
│  │ pool = {                                                │   │
│  │   "sample.txt": ["id1", "id2", ...],                   │   │
│  │   "sample2.txt": ["id10", "id11", ...],                │   │
│  │   ...                                                   │   │
│  │ }                                                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  特徴:                                                          │
│  - Unicode NFC 正規化（macOS NFD対策）                         │
│  - バッチ取得（offset/limit）                                  │
│  - Thread-safe（threading.Lock）                              │
│  - 1source あたり最大 3000 ID                                  │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. Chunk サンプリング                                           │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ sample_n = max(count * 4, 20)                          │   │
│  │                                                         │   │
│  │ source_ids 指定あり:                                    │   │
│  │   → その source から均等にサンプル                       │   │
│  │                                                         │   │
│  │ source_ids 指定なし:                                    │   │
│  │   → 全 source から均等にサンプル                         │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       │                                        │
│                       │ sampled_ids: ["id1", "id5", ...]       │
│                       ▼                                        │
│              ┌─────────────────┐                               │
│              │ collection.get  │                               │
│              │ (ids, docs,     │                               │
│              │  metadatas)     │                               │
│              └────────┬────────┘                               │
│                       │                                        │
│                       │ chunks: [{id, document, metadata}]     │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. Chunk 選択（難易度別フィルタ）                                │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ スコアリング（ヒューリスティック）:                       │   │
│  │                                                         │   │
│  │ beginner:                                               │   │
│  │   - キーワード: 概要/定義/目的/基本/ルール              │   │
│  │                                                         │   │
│  │ intermediate:                                           │   │
│  │   - キーワード: 手順/方法/対応/フロー/操作              │   │
│  │                                                         │   │
│  │ advanced:                                               │   │
│  │   - キーワード: 例外/禁止/注意/判断/リスク              │   │
│  │                                                         │   │
│  │ ボーナス:                                                │   │
│  │   - 見出し（##, ###）                                   │   │
│  │   - 最適な長さ（200〜800文字）                          │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       │                                        │
│                       │ selected_chunks: top_n 件               │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 5. Citation 作成                                                │
│                                                                 │
│  最低 3 件の Citations を確保:                                   │
│  - 不足なら sample_n を増やして再取得（最大2回）                 │
│  - 重複排除（source, page, quote先頭60文字）                    │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 6. LLM クイズ生成（3層ガード）                                   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Layer 1: Prompt 強化                                    │   │
│  │  - "JSONのみ出力"を強制                                 │   │
│  │  - 出力例を提示                                         │   │
│  │  - よくある間違いを明示                                  │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       ▼                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Ollama LLM                                              │   │
│  │  - count 個の○×クイズを JSON で生成                     │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       ▼                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Layer 2: Robust JSON Parse                             │   │
│  │  - コードフェンス除去                                    │   │
│  │  - 先頭/末尾の余計な文字除去                             │   │
│  │  - {} 抽出                                              │   │
│  │  - json.loads()                                         │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       │                                        │
│                       ▼                                        │
│              ┌─────────────────┐                               │
│              │ Parse Success?  │                               │
│              └────────┬────────┘                               │
│                       │ No                                     │
│                       ▼                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Layer 3: JSON修復リトライ（1回のみ）                     │   │
│  │  - 修復専用プロンプト                                    │   │
│  │  - 同一 citations                                        │   │
│  │  - 前回のエラー内容を含める                              │   │
│  └────────────────────┬────────────────────────────────────┘   │
│                       │                                        │
│                       ▼                                        │
│              ┌─────────────────┐                               │
│              │  Ollama LLM     │                               │
│              │  (修復試行)      │                               │
│              └────────┬────────┘                               │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 7. バリデーション                                               │
│                                                                 │
│  各クイズアイテムをチェック:                                     │
│  - statement に疑問符（?/?）がないか                            │
│  - type が "true_false" か                                      │
│  - answer_bool が bool 型か                                     │
│  - citations が1件以上あるか                                    │
└───────────────────────┼─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 8. レスポンス返却                                               │
│                                                                 │
│  {                                                              │
│    "quizzes": [                                                 │
│      {                                                          │
│        "id": "abc123",                                          │
│        "type": "true_false",                                    │
│        "statement": "地震時は最初に身を守る行動をとる。",       │
│        "answer_bool": true,                                     │
│        "explanation": "マニュアルに明記されている。",           │
│        "citations": [...]                                       │
│      },                                                         │
│      ...                                                        │
│    ]                                                            │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
```

### 主要パラメータ

| パラメータ | デフォルト値 | 説明 |
|-----------|------------|------|
| quiz_pool_max_ids_per_source | 3000 | 1sourceあたりの最大保持ID数 |
| quiz_sample_multiplier | 4 | サンプル数の倍率 |
| quiz_sample_min_n | 20 | サンプル数の最小値 |
| quiz_citations_min | 3 | 最低引用数 |
| quiz_quote_max_len | 200 | 引用の最大文字数 |

---

## RAGパイプライン詳細

### 1. ドキュメント読み込み（Indexing）

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. ファイル読み込み                                              │
│                                                                 │
│  manuals/ ディレクトリから:                                      │
│  - *.txt → テキストファイル読み込み                              │
│  - *.pdf → PyMuPDF でページ単位テキスト抽出                      │
└───────────────────────┬─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. チャンク分割（LEN戦略）                                       │
│                                                                 │
│  パラメータ:                                                    │
│  - chunk_size: 800文字                                          │
│  - chunk_overlap: 120文字                                       │
│                                                                 │
│  処理:                                                          │
│  - 改行で段落分割                                                │
│  - chunk_size に収まるように結合                                 │
│  - 長すぎる段落は chunk_size で分割                              │
│  - chunk_overlap で重複を持たせる                                │
└───────────────────────┬─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. Embedding 生成                                               │
│                                                                 │
│  モデル: intfloat/multilingual-e5-small                         │
│  - 各チャンクテキスト → 384次元ベクトル                          │
│  - CPU/GPU 自動選択                                             │
│  - バッチ処理（高速化）                                          │
└───────────────────────┬─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. ChromaDB 保存（upsert）                                      │
│                                                                 │
│  各チャンクを保存:                                               │
│  - id: "source:page:chunk_index"                                │
│  - embedding: [0.1, 0.2, ...]                                   │
│  - document: チャンクテキスト                                    │
│  - metadata: {source, page, chunk_index}                        │
│                                                                 │
│  upsert で重複を自動更新                                         │
└─────────────────────────────────────────────────────────────────┘
```

### 2. ハイブリッド検索（QA機能）

```
┌─────────────────────────────────────────────────────────────────┐
│ Semantic Search (ChromaDB)                                      │
│                                                                 │
│  query → Embedding → コサイン類似度検索 → Top-K                  │
│                                                                 │
│  特徴:                                                          │
│  - 意味的な類似度を捉える                                        │
│  - 同義語・言い換えに強い                                        │
│  - 候補数: candidate_k                                          │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ Keyword Search (BM25)                                           │
│                                                                 │
│  query → トークン化 → BM25スコア計算 → Top-K                     │
│                                                                 │
│  特徴:                                                          │
│  - 正確な単語マッチに強い                                        │
│  - 専門用語・固有名詞に強い                                      │
│  - TF-IDF ベースのスコアリング                                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ RRF (Reciprocal Rank Fusion)                                   │
│                                                                 │
│  Semantic と Keyword の結果を融合:                               │
│                                                                 │
│  RRF_score = Σ (1 / (k + rank))                                │
│  k = 20 (パラメータ)                                            │
│                                                                 │
│  特徴:                                                          │
│  - 順位ベースの融合（スコア正規化不要）                          │
│  - semantic_weight で調整可能                                   │
│  - 両方の強みを活かす                                            │
└─────────────────────────────────────────────────────────────────┘
```

### 3. Cross-Encoder リランキング

```
┌─────────────────────────────────────────────────────────────────┐
│ モデル: cross-encoder/mmarco-mMiniLMv2-L12-H384-v1              │
│                                                                 │
│  処理:                                                          │
│  1. (query, document) ペアごとにスコアリング                     │
│  2. スコアで降順ソート                                           │
│  3. 絶対値閾値でフィルタ（-1.5以下を除外）                       │
│  4. Gap閾値でフィルタ（トップとの差6.0以上を除外）               │
│  5. Top-K を選択                                                │
│                                                                 │
│  特徴:                                                          │
│  - Bi-Encoder（Semantic）より高精度                             │
│  - 計算コストが高いため候補を絞ってから適用                       │
│  - 多言語対応（日本語含む）                                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## ディレクトリ構成とファイル役割

### Backend

```
backend/app/
├── core/
│   ├── settings.py          # 設定管理（Pydantic Settings）
│   └── errors.py            # カスタムエラー定義
├── docs/
│   ├── loader.py            # ドキュメント読み込み（txt/pdf）
│   ├── chunker.py           # チャンク分割（LEN戦略）
│   └── models.py            # Document/Chunk型定義
├── rag/
│   ├── embedding.py         # Embedding生成（sentence-transformers）
│   ├── vectorstore.py       # ChromaDB操作
│   ├── hybrid_retrieval.py  # ハイブリッド検索（QA用）
│   ├── quiz_retrieval.py    # Quiz用検索（deprecated）
│   └── indexer.py           # インデックス構築
├── quiz/
│   ├── chunk_pool.py        # Chunk Pool（教材サンプリング）
│   ├── chunk_selector.py    # 難易度別フィルタ
│   ├── retrieval.py         # サンプリングベースretrieval
│   ├── generator.py         # LLMクイズ生成（3層ガード）
│   ├── parser.py            # JSON Parse（堅牢版）
│   └── validator.py         # バリデーション
├── search/
│   ├── index.py             # BM25インデックス
│   ├── keyword.py           # キーワード検索
│   ├── reranker.py          # Cross-Encoder リランキング
│   ├── snippet.py           # スニペット生成
│   └── cache.py             # キャッシュ管理
├── llm/
│   ├── base.py              # LLM抽象クラス
│   ├── ollama.py            # Ollama実装
│   └── prompt.py            # プロンプト生成（QA/Quiz）
├── routers/
│   ├── ask.py               # QA API
│   ├── quiz.py              # Quiz API
│   ├── search.py            # 検索 API
│   ├── docs.py              # ドキュメント API
│   ├── sources.py           # 資料一覧 API
│   └── health.py            # ヘルスチェック API
├── schemas/
│   ├── common.py            # 共通スキーマ（Citation等）
│   └── quiz.py              # Quizスキーマ
└── main.py                  # FastAPI アプリケーション
```

### Frontend

```
frontend/
├── app/
│   ├── page.tsx             # ホームページ
│   ├── ask/
│   │   └── page.tsx         # QAページ
│   ├── quiz/
│   │   └── page.tsx         # Quizページ
│   └── layout.tsx           # レイアウト
├── features/
│   ├── quiz/
│   │   ├── QuizPage.tsx     # Quiz メインコンポーネント
│   │   ├── useQuiz.ts       # Quiz カスタムフック
│   │   └── components/      # Quiz サブコンポーネント
│   └── ...
├── lib/
│   ├── api.ts               # API クライアント
│   └── types.ts             # 型定義
└── components/              # 共通コンポーネント
```

---

## まとめ

このシステムは、RAG（Retrieval-Augmented Generation）技術を活用して：

1. **QA機能**: ハイブリッド検索（Semantic + Keyword）+ Cross-Encoder リランキング + LLM で高品質な回答を生成
2. **Quiz機能**: 教材サンプリング + 難易度別フィルタ + 3層ガード（Prompt強化 + Robust parse + JSON修復）で安定したクイズ生成

を実現しています。

各レイヤーが明確に分離されており、保守性と拡張性が高い設計になっています。
